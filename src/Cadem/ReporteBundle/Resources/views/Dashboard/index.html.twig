{% extends '::base.html.twig' %}

{% block title %}Cadem Analytics{% endblock %}

{% block filtro %}
	<form id="filtros" action="" method="post" >
		{% for form in forms %}
				{{ form_widget(form) }}
		{% endfor %}
		<input class="btn btn-primary" type="submit" value="Filtrar" />
	</form>
{% endblock %}

{% block body %}
		<div class="span9">
			<div class="container-fluid well" style="padding-top:0">
				<h4>{{estudios[0].getNombre}}</h4>
				<div class="hero-unit" style="padding:15px;margin-bottom:10px">
					<!-- <h3>Indicadores</h3> -->
					<div class="row-fluid">
					{% for ev in estudios[0].getEstudiovariables %}
						<div class="span3">
							
							<div id="i_{{ev.getVariable.getNombre}}" style="height: 200px;"></div>
							
						</div>
					{% endfor %}
					</div>
				</div>
				{% for ev in estudios[0].getEstudiovariables %}
				<div class="hero-unit" style="padding:15px;margin-bottom:10px">
					<div id="evo_{{ev.getVariable.getNombre}}" style="min-width: 250px; height: 300px; margin: 0 auto"></div>
				</div>
				{% endfor %}
			</div>
			
			
			
			
			<div class="row-fluid">
		{% for n in noticias %}
			<div class="span6 well">

{% set t = 
n.titulo~"
========================="%}
			{{ t  | rst2html | raw}}
			{{ n.cuerpo | rst2html | raw}}

			<!--  <p><a class="btn" href="#">Ver detalles &raquo;</a></p> -->
			</div>
		{% endfor %}
			

          </div><!--/row-->
		  
        </div><!--/span-->
{% endblock %}


{% block javascripts %}
<script src="{{ asset('bundles/cademreporte/js/highcharts.regression.js') }}"></script>
<script src="{{ asset('bundles/cademreporte/js/highcharts-more.js') }}"></script>
<script>
{% for ev in estudios[0].getEstudiovariables %}
{{"var i_"~ev.getVariable.getNombre~";"}}
{{"var evo_"~ev.getVariable.getNombre~";"}}
{% endfor %}

$(document).ready(function () {
		
	
	{% for ev in estudios[0].getEstudiovariables %}//COMIENZA FOR
	
		{% if ev.getVariable.getNombre == "QUIEBRE" or ev.getVariable.getNombre == "PRESENCIA"  %}
		
		{{"i_"~ev.getVariable.getNombre}} = new Highcharts.Chart({
			chart: {
				type: 'gauge',
				plotBackgroundColor: null,
				plotBackgroundImage: null,
				plotBorderWidth: 0,
				plotShadow: false,
				renderTo: '{{"i_"~ev.getVariable.getNombre}}'
			},
			
			title: {
				text: '{{ev.getNombrevariable}}'
			},
			
			pane: {
				startAngle: -150,
				endAngle: 150,
				background: [{
					backgroundColor: {
						linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
						stops: [
							[0, '#FFF'],
							[1, '#333']
						]
					},
					borderWidth: 0,
					outerRadius: '109%'
				}, {
					backgroundColor: {
						linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
						stops: [
							[0, '#333'],
							[1, '#FFF']
						]
					},
					borderWidth: 1,
					outerRadius: '107%'
				}, {
					// default background
				}, {
					backgroundColor: '#DDD',
					borderWidth: 0,
					outerRadius: '105%',
					innerRadius: '103%'
				}]
			},
			   
			// the value axis
			yAxis: {
				min: 0,
				max: 100,
				
				minorTickInterval: 'auto',
				minorTickWidth: 1,
				minorTickLength: 10,
				minorTickPosition: 'inside',
				minorTickColor: '#666',
		
				tickPixelInterval: 30,
				tickWidth: 2,
				tickPosition: 'inside',
				tickLength: 10,
				tickColor: '#666',
				labels: {
					step: 2,
					rotation: 'auto'
				},
				title: {
					text: '%',
					y: 15
				},
				plotBands: [{
					from: 0,
					to: 30,
					innerRadius: '95%',
					color: '#55BF3B' // green
				}, {
					from: 30,
					to: 70,
					innerRadius: '95%',
					color: '#DDDF0D' // yellow
				}, {
					from: 70,
					to: 100,
					innerRadius: '95%',
					color: '#DF5353' // red
				}]        
			},
		
			series: [{
				name: 'Quiebre',
				data: [{{attribute(indicadores,ev.getVariable.getNombre)|number_format(1)}}],
				tooltip: {
					valueSuffix: ' %'
				},
				dataLabels: {
					formatter: function () {
						return  this.y.toString().replace(".",",");	
					}
				}
			}],
			credits: {
					enabled: false
				}
		});
		
		{% endif %}


		{% if ev.getVariable.getNombre == "PRECIO"  %}
		
		{{"i_"~ev.getVariable.getNombre}} = new Highcharts.Chart({
			chart: {
				type: 'gauge',
				plotBackgroundColor: null,
				plotBackgroundImage: null,
				plotBorderWidth: 0,
				plotShadow: false,
				renderTo: '{{"i_"~ev.getVariable.getNombre}}'
			},
			
			title: {
				text: '{{ev.getNombrevariable}}'
			},
			
			pane: {
				startAngle: -150,
				endAngle: 150,
				background: [{
					backgroundColor: {
						linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
						stops: [
							[0, '#FFF'],
							[1, '#333']
						]
					},
					borderWidth: 0,
					outerRadius: '109%'
				}, {
					backgroundColor: {
						linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
						stops: [
							[0, '#333'],
							[1, '#FFF']
						]
					},
					borderWidth: 1,
					outerRadius: '107%'
				}, {
					// default background
				}, {
					backgroundColor: '#DDD',
					borderWidth: 0,
					outerRadius: '105%',
					innerRadius: '103%'
				}]
			},
			   
			// the value axis
			yAxis: {
				min: 0,
				max: 100,
				
				minorTickInterval: 'auto',
				minorTickWidth: 1,
				minorTickLength: 10,
				minorTickPosition: 'inside',
				minorTickColor: '#666',
		
				tickPixelInterval: 30,
				tickWidth: 2,
				tickPosition: 'inside',
				tickLength: 10,
				tickColor: '#666',
				labels: {
					step: 2,
					rotation: 'auto'
				},
				title: {
					text: '%',
					y: 15
				},
				plotBands: [{
					from: 0,
					to: 30,
					innerRadius: '95%',
					color: '#55BF3B' // green
				}, {
					from: 30,
					to: 70,
					innerRadius: '95%',
					color: '#DDDF0D' // yellow
				}, {
					from: 70,
					to: 100,
					innerRadius: '95%',
					color: '#DF5353' // red
				}]        
			},
		
			series: [{
				name: 'Quiebre',
				data: [{{attribute(indicadores,ev.getVariable.getNombre)|number_format(1)}}],
				tooltip: {
					valueSuffix: ' %'
				},
				dataLabels: {
					formatter: function () {
						return  this.y.toString().replace(".",",");	
					}
				}
			}],
			credits: {
					enabled: false
				}
		});
		
		{% endif %}





		
	{% endfor %}//TERMINA FOR

	
	$.get( "{{ path('dashboard_indicadores') }}", $('form#filtros').serialize(), function(data) {
	
		{% for ev in estudios[0].getEstudiovariables %}//COMIENZA FOR
		
			{% if ev.getVariable.getNombre == "QUIEBRE" or ev.getVariable.getNombre == "PRESENCIA" %}
			
			
			
			{{"evo_"~ev.getVariable.getNombre}} = new Highcharts.Chart({
				chart: {
					zoomType: 'x',
					renderTo: '{{"evo_"~ev.getVariable.getNombre}}'
				},
				title: {
					text: 'Evolutivo'
				},
				xAxis: {
					categories: data.evolutivo.mediciones
					//type: 'category'
					// labels: {
						// formatter: function() {
							// alert(this.value);
								// return this.value;
						// // }
					// }
				},
				yAxis: [{
					title: {
						text: 'Promedio {{ev.getVariable.getNombre}}',
						style: {
							color: '#4572A7'
						}
					}
				}
				// ,
				// {
				// 	title: {
				// 		text: 'Incumplimiento Precio',
				// 		style: {
				// 			color: 'red'
				// 		}
				// 	},
				// 	opposite: true
				// }
				],
				tooltip: {
					// shared: true,
					formatter: function() {
						return 'Medici√≥n: <b>'+ this.x +
							'</b> <br/> Valor: <b>'+ this.y +'%</b>';
					}
				},
				legend: {
					layout: 'vertical',
					align: 'center',
					x: 100,
					verticalAlign: 'top',
					y: 30,
					floating: true,
					backgroundColor: '#FFFFFF'
				},
				series: [data.evolutivo.serie_quiebre
				// , data.evolutivo.serie_precio
				],
				credits: {
					enabled: false
				}
			});
			
			
			
			{% endif %}
		
		{% endfor %}
		
		
		// evo_quiebre_precio = new Highcharts.Chart({
            // chart: {
                // zoomType: 'x',
				// renderTo: 'evo_quiebre_precio'
            // },
            // title: {
                // text: 'Evolutivo Quiebre y Precio'
            // },
            // xAxis: [{
                // categories: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
                    // 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']
            // }],
            // yAxis: [{
                // title: {
                    // text: 'Promedio Quiebre (%)',
                    // style: {
                        // color: '#4572A7'
                    // }
                // }
    
            // }, {
                // //gridLineWidth: 0,
                // title: {
                    // text: 'Promedio Precio ($)',
                    // style: {
                        // color: '#89A54E'
                    // }
                // },
                // opposite: true
            // }],
            // tooltip: {
                // shared: true
            // },
            // legend: {
                // layout: 'vertical',
                // align: 'center',
                // x: 0,
                // verticalAlign: 'top',
                // y: 30,
                // floating: true,
                // backgroundColor: '#FFFFFF'
            // },
            // series: [data.evo_quiebre_precio.precio, data.evo_quiebre_precio.quiebre,
			// {
				// type: 'line',
				// marker: { enabled: false },
				// /* function returns data for trend-line */
				// data: (function() {
					  // return fitData(data.evo_quiebre_precio.quiebre.data).data;
					// })(),
				// name: 'Tendencia Quiebre'
			// }
			
			// ],
			// credits: {
				// enabled: false
			// },
            // plotOptions: {
                // series: {
                        // events: {
                            // legendItemClick: function () {
                                // var series = this.chart.series;
                                // var seriesIndex = this.index;
                                // if(seriesIndex == 1){//QUIEBRE
                                    // if(series[1].visible == false && series[0].visible == false) mostrarbandaquiebre();
                                    // if(series[1].visible == true && series[0].visible == true) mostrarbandaprecio();
                                // }
                                // if(seriesIndex == 0){//PRECIO
                                    // if(series[1].visible == true && series[0].visible == true) mostrarbandaquiebre();
                                    // if(series[1].visible == false && series[0].visible == false) mostrarbandaprecio();
                                // }
                                
                                // if((series[0].visible == false && series[1].visible == true) || (series[0].visible == true && series[1].visible == false)) borrarbandas();
                                
                                
                                
                                // //return false; // <== returning false will cancel the default action
                            // }
                        // }
                    // ,
                    // showInLegend: true
                // }
            // }
        // });
        
        function mostrarbandaquiebre(){
            borrarbandas();
            var trasparencia = 0.15;
            evo_quiebre_precio.yAxis[0].addPlotBand({ // Buen quiebre
                from: 0,
                to: 20,
                color: 'rgba(0, 200, 0, '+trasparencia+')',
                id: 'pb-q1',
                label: {
                    text: 'Quiebre aceptable',
                    style: {
                        color: '#606060'
                    }
                }
            });
            evo_quiebre_precio.yAxis[0].addPlotBand({ // Intermedio quiebre
                from: 20,
                to: 40,
                color: 'rgba(200, 200, 0, '+trasparencia+')',
                id: 'pb-q2',
                label: {
                    text: 'Quiebre peligroso',
                    style: {
                        color: '#606060'
                    }
                }
            });
            evo_quiebre_precio.yAxis[0].addPlotBand({ // Mal quiebre
                from: 40,
                to: 100,
                color: 'rgba(200, 0, 0, '+trasparencia+')',
                id: 'pb-q3',
                label: {
                    text: 'Quiebre excesivo',
                    style: {
                        color: '#606060'
                    }
                }
            });
            
        }
        
        function mostrarbandaprecio(){
            borrarbandas();
            var trasparencia = 0.15;
            evo_quiebre_precio.yAxis[1].addPlotBand({ // Buen quiebre
                from: 0,
                to: 3000,
                color: 'rgba(0, 200, 0, '+trasparencia+')',
                id: 'pb-p1',
                label: {
                    text: 'Precio aceptable',
                    style: {
                        color: '#606060'
                    }
                }
            });
            evo_quiebre_precio.yAxis[1].addPlotBand({ // Intermedio quiebre
                from: 3000,
                to: 5000,
                color: 'rgba(200, 0, 0, '+trasparencia+')',
                id: 'pb-p2',
                label: {
                    text: 'Precio peligroso',
                    style: {
                        color: '#606060'
                    }
                }
            });
            
        }
        
        function borrarbandas(){
            evo_quiebre_precio.yAxis[0].removePlotBand('pb-q1');
            evo_quiebre_precio.yAxis[0].removePlotBand('pb-q2');
            evo_quiebre_precio.yAxis[0].removePlotBand('pb-q3');
            evo_quiebre_precio.yAxis[1].removePlotBand('pb-p1');
            evo_quiebre_precio.yAxis[1].removePlotBand('pb-p2');
        }
		
		
		
	
	});
	
	
	
	
	
});
 </script>
{% endblock %}