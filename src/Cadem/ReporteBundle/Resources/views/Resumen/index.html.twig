{% extends '::base.html.twig' %}

{% block title %}Cadem Reporte{% endblock %}

{% block filtro %}
	<form id="filtros" action="" method="post" >
		{% for form in forms %}
				{{ form_widget(form) }}
		{% endfor %}
	<input class="btn btn-primary" type="submit" value="Filtrar" />
	<input class="btn btn-warning" type="submit" value="Limpiar Filtros" />
{% endblock %}

{% block body %}
    <div class="span9">
		<div class="container-fluid well" style="padding-top:0">
			<h4>Vista Resumen de Quiebre:</h4>
				<div class="hero-unit" style="padding:15px;margin-bottom:10px">
					<div class="row-fluid">
							<table id="tabla_resumen" class="table table-bordered display" width='100%'>                      
								<thead style='position:static'>
									<tr>
										{% for item in tabla_resumen.head %}
										<th width='10%' title="{{item|upper}}" tag="{{item|upper}}">
											{% if item|replace({' ':'_'})|length>8 and loop.index>2 %}
												{{item|replace({' ':'_'})[0:8]|upper}}...
											{% else %}
												{{item|upper}}
											{% endif %}
											{% if loop.index>2 %}											
											{% endif %}
										</th>
										{% endfor %}
									</tr>
								</thead>
								<tbody>
									{% for item in tabla_resumen.body %}
										{% set acum = 0 %}
										<tr class='{{item['segmento']|trim}} head' data-tt-id="{{loop.index}}" data-tt-parent-id="{{item['segmento']}}">
											{% for item2 in item %}
											{% if loop.index > 2 %}
											<td value={{item2}} class='{{item['segmento']|trim}}'>  
												{{item2}}
											</td>
											{% elseif loop.index==2 %}
											<td class='{{item['categoria']|trim}} tag' title="{{item['categoria']|upper}}" tag="{{item['categoria']|upper}}">  
												{% if item2|replace({' ':'_'})|length>15 %}
												{{item2|replace({' ':'_'})[0:15]|upper}}...
												{% else %}
												{{item2|upper}}
												{% endif %}											
											</td>
											{% else %}
											<td value={{item2}} class='{{item['segmento']|trim}}' title="{{item['categoria']|upper}}"> 
												{% if loop.index<=2 %}
													{{item2|upper}}													
												{% else %}
													{{item2}}
												{% endif %}												
											</td>
											{% endif %}
											{% set acum = acum + item2 %}
											{% endfor %}
											<td class='total' value={{ acum }}>
												{{'%.1f'|format(acum/((item|length)-2))}}%
											</td>
										</tr>
									{% endfor %}
								</tbody>                        					                   
							</table>			
					</div><!--/row-->   
				</div>
					<div class="hero-unit" style="padding:30px">
							<div class="row-fluid">
							{# {% for item in variables_clientes %} #}
								<div id="i_quiebre" ></div>
							{# {% endfor %} #}			
							</div>
					</div>             
				</div><!--/span-->
			</div>
		</div>
{% endblock %}

{% block customstyles %}

div.dataTables_scroll { 
	clear: both !important; 
}

td{
	font-size: .64em !important;
	text-align: center !important;
}

th{
	font-size: .64em !important;
	text-align: center !important;
}

.head :nth-child(1){
	text-align: left !important;
}

span.indenter{
	padding-left:0em !important;
}

.hero-unit select{
	width: auto;
	padding: 0;
	margin-bottom: 0;
}

.hero-unit input{
	width: auto;
	padding: 0;
	margin-bottom: 0;
}

.hero-unit label{
	margin-bottom: 0;
}

.total {
	background-color:'#F7FE2E' !important;
}

legend {
	font-size: 12px !important;
	font-weight: bold !important;
	margin-bottom: 10px !important;
	color: '#999' !important;
}
{% endblock %}

{% block stylesheets %}

<link href="{{ asset('bundles/cademreporte/css/demo_table.css') }}" rel="stylesheet">		

<link href="{{ asset('bundles/cademreporte/css/jquery.treetable.css') }}" rel="stylesheet">		  
<link href="{{ asset('bundles/cademreporte/css/jquery.treetable.theme.default.css') }}" rel="stylesheet">

<link href="{{ asset('bundles/cademreporte/css/jquery.dataTables_themeroller.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/cademreporte/css/redmond/jquery-ui.min.css') }}" rel="stylesheet">

{% endblock %}

{% block javascripts %}
<script src="{{ asset('bundles/cademreporte/js/jquery.dataTables.min.js') }}"></script>

<script src="{{ asset('bundles/cademreporte/js/jquery.treetable.js') }}"></script>

<!-- <script src="{{ asset('bundles/cademreporte/js/FixedColumns.js') }}"></script> -->
<script src="{{ asset('bundles/cademreporte/js/jquery-ui.min.js') }}"></script>

<script>
//{% for item in variables_clientes %}
//{{"var i_"~item.variable.nombre~";"}}
//{% endfor %}

var i_quiebre;
var periodo = {{ periodos|raw }};

$(document).ready(function () {
	
	
	
	{% for item in variables_clientes %}
        {% if loop.index == 1 %}
		//{{"i_"~item.variable.nombre}} = new Highcharts.Chart({
		i_quiebre = new Highcharts.Chart({
		chart: {    
			renderTo: 'i_quiebre',
                        type: 'spline',
                        //marginRight: 130,
                        //marginBottom: 25,                                
			plotBackgroundColor: null,
			plotBorderWidth: null,
			plotShadow: false,
                        width: 900,
                        height: 350                        
		},
		title: {
			text: 'Evoluci√≥n Quiebre'
		},
		tooltip: {
			pointFormat: '{series.name}: <b>{point.percentage}%</b>',
			percentageDecimals: 1,
			enabled: true
		},
		xAxis: {
            categories: periodo.data,
			
			labels: {
                rotation: 0
            }			
		},		
		yAxis: {
	        max: 100,
			min: 0,
            //categories: [0,100],
			title: {
                    text: 'Promedio Quiebre (%)'
            }
		},		
		series: [{
                    name: '% Quiebre',
                    data: {{ evolutivo }},			
                }],
		legend: {
               layout: 'vertical',
               align: 'center',
               x: 400,
               verticalAlign: 'top',
               y: 0,
               floating: true,
            },				
		credits: {
			enabled: false
		}
	});
        {% endif %}
	{% endfor %}
	
	cargartooltip();
	});	

	oTable = $('#tabla_resumen').dataTable({
		"sScrollY": "210px",
		"sScrollX": "100%",
 		//"sScrollXInner": "150%",
 		//"bScrollCollapse": true,
		"bFilter": false,
		"bSort": false,
		"bInfo": false,
		"bPaginate": false,
		"bJQueryUI": true,
		"bAutoWidth": false, 
		"aoColumnDefs": [
			{ "bVisible": false, "aTargets": [ 0 ] },
			{ "aTargets": [ 1 ], "sClass": "head", "sWidth":'20%' },	
		],
		"aaSortingFixed": [[ 0, 'asc' ]],
		"aaSorting": [[ 1, 'asc' ]],
		"sDom": '<"H"Cfr>t<"F"ip>',	
		"fnDrawCallback": function ( oSettings ) {
			var cols=this.fnSettings().aoColumns.length-1;
			if ( oSettings.aiDisplay.length == 0 )
			{
				return;
			}
			var nTrs = $('#tabla_resumen tbody tr');
			var iColspan = nTrs[0].getElementsByTagName('td').length;
			//var nColumns =
			var sLastGroup = "";
			
			for ( var i=0 ; i<nTrs.length ; i++ )
			{
				var iDisplayIndex = oSettings._iDisplayStart + i;
				var sGroup = oSettings.aoData[ oSettings.aiDisplay[iDisplayIndex] ]._aData[0];
				
				if ( sGroup != sLastGroup )
				{	
					var nGroup = document.createElement( 'tr' );
					
					var nCells= new Array();
					
					for(var j=0 ; j<cols ; j++)
					{
						nCells[j] = document.createElement( 'td' );
						// nCells[j].colSpan=iColspan;
						nCells[j].className = "group";	
						var att=document.createAttribute("title");
						att.value=sGroup.toUpperCase();;
						nCells[j].setAttributeNode(att);				
						var att=document.createAttribute("tag");
						att.value=sGroup.toUpperCase();;
						nCells[j].setAttributeNode(att);						
						
						if(j==0)
						{
							nCells[j].innerHTML = sGroup;
							nCells[j].className = nCells[j].className+" tag";
						}
						else
						{			
							nCells[j].innerHTML = 0;//totales[j];
						}
						nGroup.appendChild( nCells[j] );
						// break;
					}
					nTrs[i].parentNode.insertBefore( nGroup, nTrs[i] );
					
					var att=document.createAttribute("data-tt-id");
					att.value=sGroup.toLowerCase();
					nTrs[i].previousSibling.setAttributeNode(att);
					
					var att=document.createAttribute("class");
					att.value="parent head";
					nTrs[i].previousSibling.setAttributeNode(att);					
					
					sLastGroup = sGroup;
				}
			}
		},
		"fnInitComplete": function () {
			$('#tabla_resumen tbody tr td').tooltip({
				position: {
					track: true
				}
			});		
			var cols=this.fnSettings().aoColumns.length-1;
            this.fnAdjustColumnSizing();
            this.fnDraw();
			var totalesGlobales=new Array();
			var contGlobal=0;
			for (var i = 0; i < cols; i++) totalesGlobales[i] = 0;
			$('#tabla_resumen tbody tr.parent').each(function(){
				var totalesParciales= new Array();
				for (var i = 0; i < cols; i++) totalesParciales[i] = 0;
				var cont=0;
				$('#tabla_resumen tbody tr[data-tt-parent-id="'+$(this).attr('data-tt-id')+'"]').each(function(){
					var j=0;
					contGlobal++;
					$(this).children().each(function(){
						if(j>0)
							totalesParciales[j-1]=totalesParciales[j-1]+parseInt($(this).attr('value'));
						j++;
					});
					cont++;
				});
				var j=0;
				$(this).children().each(function(){
					if(j>0)
					{
						
						$(this).text(parseFloat((totalesParciales[j-1]/cont)).toFixed(1));
						totalesGlobales[j-1]=totalesGlobales[j-1]+totalesParciales[j-1];
						//$(this).attr('value',parseFloat((totalesParciales[j-1])/7)).round(2);
					}
					j++;
				});
			});
			var nTrs = $('#tabla_resumen tbody tr');
			var nGroup = document.createElement( 'tr' );
			var nCells= new Array();
					
			for(var j=0 ; j<cols ; j++)
			{
				nCells[j] = document.createElement( 'td' );
				// nCells[j].colSpan=iColspan;		
				nCells[j].className = "group";

				var att=document.createAttribute("title");
				att.value="QUIEBRE GENERAL";
				nCells[j].setAttributeNode(att);				
				var att=document.createAttribute("tag");
				att.value="QUIEBRE GENERAL";
				nCells[j].setAttributeNode(att);					
						
				if(j==0)
				{
					nCells[j].innerHTML = "QUIEBRE GENERAL";
					nCells[j].className = nCells[j].className+" tag";
				}
				else
				{			
					nCells[j].innerHTML = parseFloat((totalesGlobales[j-1])/contGlobal).toFixed(1);//totales[j];
				}
				nGroup.appendChild( nCells[j] );
			}
			nTrs[0].parentNode.insertBefore( nGroup, nTrs[0] );
			var att=document.createAttribute("class");
			att.value="parent head";
			nTrs[0].previousSibling.setAttributeNode(att);
			
			$('#tabla_resumen tbody tr td.tag').click(function() {
				var label= $(this).attr('tag');
			
				$(".ui-state-active").removeClass("ui-state-active");
				$(this).parent().addClass("ui-state-active");
				$.get( "{{ path('resumen_evolutivo') }}", label, function(data) {	
					{% for item in variables_clientes %}
						{% if loop.index == 1 %}
							i_quiebre.series[0].setData(data); 
							i_quiebre.setTitle({ text: "Evolucion Quiebre '"+label +"'"});
						{% endif %}
					{% endfor %}
					cargartooltip();
				});	
			});				
		  }	
		});
		
		$('div.fg-toolbar:first').append("<h5 style='float:left;margin:0em'>Tabla Resumen Quiebre: (%) de Quiebre Categoria/Cadena</h5>");
		
		// new FixedColumns( oTable );
		
		$("#tabla_resumen").treetable({ 
			expandable: true, 
			onNodeExpand: function () {			
			}
		});	
	
		
		$('thead th').click(function() {
			var label= $(this).attr('tag');
		
			$(".ui-state-active").removeClass("ui-state-active");
			$(this).addClass("ui-state-active");
			$.get( "{{ path('resumen_evolutivo') }}", label, function(data) {	
				{% for item in variables_clientes %}
					{% if loop.index == 1 %}
						i_quiebre.series[0].setData(data); 
						i_quiebre.setTitle({ text: "Evolucion Quiebre '"+label +"'"});
					{% endif %}
				{% endfor %}
				cargartooltip();
			});
		});
		
		
		//GUARDA QUE BOTON SE PRESIONA EN EL FORMULARIO
		var $boton_presionado;
		$('form#filtros input').click(function() {
			$boton_presionado = $(this);
		});
		
		//LOGICA DEL SUBMIT DEL FORMULARIO, SE DEBERIA OCUPAR AJAX
		$('form#filtros').submit(function() {
			if($boton_presionado.attr("value") === "Limpiar Filtros"){
				$('form#filtros select[multiple="multiple"] option').prop('selected',true);
			}
			if($boton_presionado.attr("value") === "Filtrar"){
				$.get( "{{ path('resumen_periodo') }}", $(this).serialize(), function(data) {

					$('#tabla_resumen tbody tr').each(function(){
						var cont=0;
						$(this).children().each(function(){
							if(cont>0)
								$(this).text(Math.floor((Math.random()*100)+1));
							cont++;
						});
					});
				{% for item in variables_clientes %}
					{% if loop.index == 1 %}
						i_quiebre.series[0].setData(data.evolutivo); 
						i_quiebre.setTitle({ text: "Evolucion Quiebre General"});
					{% endif %}
				{% endfor %} 
				},
				'json');
			}
		return false;
	});

	function cargartooltip(){
		$.each(periodo.data, function(index, value) {
			$('div#i_quiebre tspan:contains("'+value+'")').attr('title', periodo.tooltip[index])
			.tooltip({
				track: true
			});
		});	
	}

	
 </script>
{% endblock %}