{% extends '::base.html.twig' %}

{% block title %}Cadem Reporte{% endblock %}

{% block filtro %}
	<form id="filtros" action="" method="post" >
		{% for form in forms %}
				{{ form_widget(form) }}
		{% endfor %}
		<input class="btn btn-primary" type="submit" value="Filtrar" />
	</form>
{% endblock %}

{% block body %}
    <div class="span9">
		<div class="container-fluid well" style="padding-top:0">
			<h4>Resumen Quiebre</h4>
				<div class="hero-unit" style="padding:15px;margin-bottom:10px">
					<div class="row-fluid">
							<table id="tabla_resumen" class="table table-bordered display">                      
								<thead style='position:static'>
									<tr>
										{% for item in tabla_resumen.head %}
										<th width='12%'>
											{{item}}
										</th>
										{% endfor %}
									</tr>
								</thead>
								<tbody>
									{% for item in tabla_resumen.body %}
										{% set acum = 0 %}
										<tr class='{{item['segmento']|trim}}' data-tt-id="{{loop.index}}" data-tt-parent-id="{{item['segmento']}}">
											{% for item2 in item %}
											<td id_col="{{loop.index-1}}" id_fil="{{loop.parent.loop.index-1}}" class='{{item['segmento']|trim}}'>  
												{{item2}}
											</td>
											{% set acum = acum + item2 %}
											{% endfor %}
											<td>
												{{ acum }}
											</td>
										</tr>
									{% endfor %}
								</tbody>                        					                   
							</table>
						
					</div><!--/row-->   
				</div>
					<div class="hero-unit" style="padding:30px">
							<div class="row-fluid">
							{% for item in variables_clientes %}
								<div id="i_{{item.variable.nombre}}" ></div>
							{% endfor %}					
							</div>
					</div>             
				</div><!--/span-->
			</div>
		</div>
{% endblock %}

{% block customstyles %}

table.table-bordered{
    margin-bottom:0px !important;
    margin-bottom:0px !important;
}

table.table-bordered thead{
	padding-right:15px !important;
}

table.treetable{
    margin:0px !important;
}

.FixedColumns_Cloned th { background-color: white !important; }
			td.index { background-color: white !important; border-right: 1px solid black !important; }
			table.display th.sorting_disabled { border-bottom: 1px solid white !important; }

{% endblock %}

{% block stylesheets %}
<link href="{{ asset('bundles/cademreporte/css/demo_page.css') }}" rel="stylesheet">
<link href="{{ asset('bundles/cademreporte/css/demo_table.css') }}" rel="stylesheet">

<link href="{{ asset('bundles/cademreporte/css/jquery.treetable.css') }}" rel="stylesheet">		  
<link href="{{ asset('bundles/cademreporte/css/jquery.treetable.theme.default.css') }}" rel="stylesheet">

<link href="{{ asset('bundles/cademreporte/css/jquery-ui-1.10.2.custom.min.css') }}" rel="stylesheet">

{% endblock %}

{% block javascripts %}
<script src="{{ asset('bundles/cademreporte/js/jquery.dataTables.js') }}"></script>
<script src="{{ asset('bundles/cademreporte/js/FixedColumns.js') }}"></script>

<script src="{{ asset('bundles/cademreporte/js/jquery.treetable.js') }}"></script>
<script src="{{ asset('bundles/cademreporte/js/script.js') }}"></script>

<script src="{{ asset('bundles/cademreporte/js/jquery-ui-1.10.2.custom.min.js') }}"></script>

<script>
{% for item in variables_clientes %}
{{"var i_"~item.variable.nombre~";"}}
{% endfor %}


$(document).ready(function () {
	
	$('#tabla_resumen tr').click(function() {
		var label= $(this).children(':first').text().trim();

		$.get( "{{ path('resumen_evolutivo') }}", $(this).text().trim(), function(data) {	
			{% for item in variables_clientes %}
				{% if loop.index == 1 %}
					{{"i_"~item.variable.nombre}}.series[0].setData(data); 
					{{"i_"~item.variable.nombre}}.setTitle({ text: "Evolucion Quiebre '"+label +"'"});
				{% endif %}
			{% endfor %}  					
		});	
	});
	
	$('#tabla_resumen_wrapper tr th').click(function() {
		var label= $(this).text().trim();

		$.get( "{{ path('resumen_evolutivo') }}", $(this).text().trim(), function(data) {	
			{% for item in variables_clientes %}
				{% if loop.index == 1 %}
					{{"i_"~item.variable.nombre}}.series[0].setData(data); 
					{{"i_"~item.variable.nombre}}.setTitle({ text: "Evolucion Quiebre '"+label +"'"});
				{% endif %}
			{% endfor %}  					
		});	
	});
	
	{% for item in variables_clientes %}
        {% if loop.index == 1 %}
		{{"i_"~item.variable.nombre}} = new Highcharts.Chart({
		chart: {    
			renderTo: 'i_{{item.variable.nombre}}',
                        type: 'line',
                        //marginRight: 130,
                        //marginBottom: 25,                                
			plotBackgroundColor: null,
			plotBorderWidth: null,
			plotShadow: false,
                        width: 900,
                        height: 200                        
		},
		title: {
			text: 'Evoluci√≥n Quiebre'
		},
		tooltip: {
			pointFormat: '{series.name}: <b>{point.percentage}%</b>',
			percentageDecimals: 1,
			enabled: true
		},
		xAxis: {
            categories: {{ periodos|raw }},
			
			labels: {
                rotation: -40
            }			
		},		
		yAxis: {
            //categories: [0,100],
			title: {
                    text: '% Quiebre'
            }
		},		
		series: [{
                    name: '% Quiebre',
                    data: {{ evolutivo }},			
                }],
		legend: {
               layout: 'vertical',
               align: 'center',
               x: 400,
               verticalAlign: 'top',
               y: 0,
               floating: true,
               backgroundColor: '#FFFFFF'
        },				
		credits: {
			enabled: false
		}
	});
        {% endif %}
	{% endfor %}   
	});	
	
	oTable = $('#tabla_resumen').dataTable({
		"sScrollY": "200px",
		"sScrollX": "100%",
		"sScrollXInner": "150%",
		"bFilter": false,
		"bSort": false,
		"bInfo": false,
		"bPaginate": false,
		"bJQueryUI": true,
		//"bScrollCollapse": true,
		"fnDrawCallback": function ( oSettings ) {
			if ( oSettings.aiDisplay.length == 0 )
			{
				return;
			}
			
			var nTrs = $('#tabla_resumen tbody tr');
			var iColspan = nTrs[0].getElementsByTagName('td').length;
			//var nColumns =
			var sLastGroup = "";
			
			for ( var i=0 ; i<nTrs.length ; i++ )
			{
				var iDisplayIndex = oSettings._iDisplayStart + i;
				var sGroup = oSettings.aoData[ oSettings.aiDisplay[iDisplayIndex] ]._aData[0];
				
				if ( sGroup != sLastGroup )
				{
					var nGroup = document.createElement( 'tr' );
					
					var nCells= new Array();
					
					for(var j=0 ; j<7 ; j++)
					{
						nCells[j] = document.createElement( 'td' );
						//nCells[j].colSpan=iColspan;
						nCells[j].className = "group";
						if(j==0 || j==1)
						{
							nCells[j].innerHTML = sGroup;
						}
						else
						{
							var total;
							
							$(this).children(":eq("+j+")").each(function(){
														
								total=0;
								
								$("#tabla_resumen tbody tr[data-tt-id="+i+"]").each(function(){
									total=total+parseInt($(this).text());
									//alert($(this).text());
								});
							});
							nCells[j].innerHTML = sGroup;
						}
						nGroup.appendChild( nCells[j] );
					}
		
					nTrs[i].parentNode.insertBefore( nGroup, nTrs[i] );
					
					var att=document.createAttribute("data-tt-id");
					att.value=sGroup;
					nTrs[i].previousSibling.setAttributeNode(att);
					
					sLastGroup = sGroup;
				}
			}
		},
		"aoColumnDefs": [
			{ "bVisible": false, "aTargets": [ 0 ] }
		],
		"aaSortingFixed": [[ 0, 'asc' ]],
		"aaSorting": [[ 1, 'asc' ]],
		"sDom": 'lfr<"giveHeight"t>ip'
		});
		
		$("#tabla_resumen").treetable({ expandable: true });	
	
		$("#tabla_resumen tbody tr").mousedown(function() {
		  $("tr.selected").removeClass("selected");
		  $(this).addClass("selected");
		});	
	
		$('form#filtros').submit(function() {
			$.get( "{{ path('resumen_periodo') }}", $(this).serialize(), function(data) {

				$('#tabla_resumen tbody tr').each(function(){
					var cont=0;
					$(this).children().each(function(){
						if(cont>0)
							$(this).text(Math.floor((Math.random()*100)+1));
						cont++;
					});
				});
			{% for item in variables_clientes %}
				{% if loop.index == 1 %}
					{{"i_"~item.variable.nombre}}.series[0].setData(data.evolutivo); 
					{{"i_"~item.variable.nombre}}.setTitle({ text: "Evolucion Quiebre General"});
				{% endif %}
			{% endfor %} 
			},
			'json');
		return false;
	});	
 </script>
{% endblock %}